name: Code Quality

on:
  push:
    branches: [main]
    paths:
      - 'Core/**'
      - 'Kernel/**'
      - 'Services/**'
      - 'Apps/**'
      - 'Applications/**'
      - 'System/**'
      - 'HalModule/**'
      - 'Connectivity/**'
      - 'UI/**'
      - 'Firmware/**'
      - 'Profiles/**'
      - '.clang-format'
      - '.clang-tidy'
      - 'scripts/**'
      - '.github/workflows/code-quality.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'Core/**'
      - 'Kernel/**'
      - 'Services/**'
      - 'Apps/**'
      - 'Applications/**'
      - 'System/**'
      - 'HalModule/**'
      - 'Connectivity/**'
      - 'UI/**'
      - 'Firmware/**'
      - 'Profiles/**'
      - '.clang-format'
      - '.clang-tidy'
      - 'scripts/**'
      - '.github/workflows/code-quality.yml'
  workflow_dispatch:

concurrency:
  group: quality-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  case-conflict:
    name: Case Conflict Check
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4

      - name: Detect case-insensitive path conflicts
        run: |
          echo "=== Case-Insensitive Path Conflict Check ==="
          echo "Detects paths that would collide on Windows/macOS"
          echo ""
          conflicts=$(git ls-files | sort -f | uniq -di)
          if [ -n "$conflicts" ]; then
            echo "❌ Case conflicts found:"
            echo "$conflicts" | while read -r name; do
              echo "  Conflict: $(git ls-files | grep -i "^${name}$")"
            done
            exit 1
          fi
          # Also check directory components
          dir_conflicts=$(git ls-files | xargs -I{} dirname {} | sort -u | sort -f | uniq -di)
          if [ -n "$dir_conflicts" ]; then
            echo "❌ Directory case conflicts found:"
            echo "$dir_conflicts"
            exit 1
          fi
          echo "✅ No case conflicts — safe for Windows/macOS"

  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Check formatting
        run: ./scripts/check_format.sh

  python-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run all Python checks
        run: |
          mkdir -p reports
          : > reports/analysis.log
          failed=0

          echo "=== Complexity Analysis ===" | tee -a reports/analysis.log
          python3 scripts/analyze_complexity.py 2>&1 | tee -a reports/analysis.log || failed=1

          echo -e "\n=== Include Analysis ===" | tee -a reports/analysis.log
          python3 scripts/analyze_includes.py 2>&1 | tee -a reports/analysis.log || failed=1

          echo -e "\n=== Naming Check ===" | tee -a reports/analysis.log
          python3 scripts/check_naming.py 2>&1 | tee -a reports/analysis.log || failed=1

          echo -e "\n=== Documentation Check ===" | tee -a reports/analysis.log
          python3 scripts/check_docs.py 2>&1 | tee -a reports/analysis.log || failed=1

          exit $failed

      - name: Upload analysis reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-analysis-reports
          path: reports/
          retention-days: 14

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [case-conflict, format-check, python-analysis]
    if: github.event_name == 'pull_request' && always()
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: scripts

      - name: Download reports
        uses: actions/download-artifact@v4
        with:
          name: code-analysis-reports
          path: reports/
        continue-on-error: true

      - name: Generate summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const caseStatus = '${{ needs.case-conflict.result }}' === 'success' ? '✅' : '❌';
            const formatStatus = '${{ needs.format-check.result }}' === 'success' ? '✅' : '❌';
            const analysisStatus = '${{ needs.python-analysis.result }}' === 'success' ? '✅' : '⚠️';

            let body = `## Code Quality Report\n\n`;
            body += `| Check | Status |\n|-------|--------|\n`;
            body += `| Case Conflicts | ${caseStatus} |\n`;
            body += `| Format | ${formatStatus} |\n`;
            body += `| Analysis | ${analysisStatus} |\n\n`;

            if (fs.existsSync('reports/analysis.log')) {
              const content = fs.readFileSync('reports/analysis.log', 'utf8');
              // Extract summaries only
              const summaryLines = content.split('\n')
                .filter(l => l.includes('===') || l.includes('Summary') || l.includes('Issues') || l.includes('✅') || l.includes('⚠️'))
                .slice(0, 30)
                .join('\n');
              body += `<details><summary>View Details</summary>\n\n\`\`\`\n${summaryLines}\n\`\`\`\n</details>`;
            }

            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } catch (err) {
              core.warning(`Skipping PR comment: ${err.message}`);
            }
